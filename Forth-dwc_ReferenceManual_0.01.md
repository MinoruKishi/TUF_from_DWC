Forth-dwc リファレンスマニュアル（ドラフト）

**forth-dwc リファレンスマニュアル（ドラフト）**

対象: CCurl/forth-dwc（最終確認: 2025-08-11） ライセンス: MIT（実装は
C/Forth）

------------------------------------------------------------------------

**1. 概要**

- **DWC (DWORD-Code)方式**の極小 Forth。スタンドアロン実行も C/C++
  への**組み込み**も可能。

- 実装は dwc-vm.c, dwc-vm.h, system.c の主に **3 ファイル**。

- 基本プリミティブは **32 個**、システムプリミティブは **13 個**。

- 各命令は 1 **DWORD** で表現（プリミティブ番号／リテラル／辞書内 XT）。

**2. ビルドと実行**

**2.1 Windows**

- Visual Studio 用の dwc.sln / dwc.vcxproj を同梱。

- **Release / Win32** でビルド推奨（最小サイズ）。

**2.2 Linux/macOS**

- makefile を利用。

- 例: make → ./dwc で起動。

実行すると外部インタプリタ（outer interpreter）が起動し、boot.fth
などをロードして対話可能。

------------------------------------------------------------------------

**3. 言語モード（ColorForth 影響）**

DWC には 4
つの状態（**State**）があり、**空白中の制御文字**で状態を切替えます。

|  **状態**    |     **意味**  |    **既定動作**|
| --- | --- | --- |
|  COMPILE     |     コンパイル |   語/数をコンパイル

  DEFINE           定義開始      語を辞書に追加し、COMPILE へ

  INTERPRET        解釈          語を即時実行

  COMMENT          コメント      )/)) 以外は無視
  -----------------------------------------------------------------------

**即時（IMMEDIATE）状態遷移語**

:, ;, \[, \], (, ), ((, ))

- : → DEFINE

- ; → EXIT をコンパイルして INTERPRET

- \[ → INTERPRET

- \] → COMPILE

- (, (( → COMMENT

- ), )) → コメント終了（それぞれ COMPILE/INTERPRET へ）

------------------------------------------------------------------------

**4. コード表現（DWORD-Code）**

- **0..44**: プリミティブ番号

- **リテラル**: 上位ビットに LIT_BITS を立てた値

- **辞書語**: XT（コードアドレス）

------------------------------------------------------------------------

**5. プリミティブ一覧**

**表記**: Stack effect は (in \-- out)、TOS=スタック最上位, NOS=次点。

**5.1 DWC プリミティブ（0--31）**

0 exit ( \-- ) RTOS を PC に復帰。PC=0 で停止。

1 lit ( \-- n ) 次ワードをプッシュ、PC++。

2 jmp ( \-- ) PC = code\[PC\]。

3 jmpz ( n \-- ) TOS==0 なら PC=code\[PC\]、else PC++。TOS 破棄。

4 jmpnz ( n \-- ) TOS!=0 なら PC=code\[PC\]、else PC++。TOS 破棄。

5 njmpz ( n \-- n ) (条件分岐, 非破壊) TOS==0 なら PC=code\[PC\]、else
PC++。

6 njmpnz ( n \-- n ) (条件分岐, 非破壊) TOS!=0 なら PC=code\[PC\]、else
PC++。

7 dup ( n \-- n n ) 複製。

8 drop ( n \-- ) 捨てる。

9 swap ( a b \-- b a ) 交換。

10 over ( a b \-- a b a ) NOS を複製。

11 ! ( n a \-- ) セル格納（a に n）。

12 @ ( a \-- n ) セル読出し。

13 c! ( b a \-- ) バイト格納。

14 c@ ( a \-- b ) バイト読出し。

15 \>r ( n \-- ) リターンスタックへプッシュ。

16 r@ ( \-- n ) RTOS を複製してデータスタックへ。

17 r\> ( \-- n ) RTOS をポップしてデータスタックへ。

18 \* ( a b \-- c ) 乗算。

19 + ( a b \-- c ) 加算。

20 - ( a b \-- c ) 減算。

21 /mod ( a b \-- r q ) 商/余。

22 \< ( a b \-- f ) a\<b → 1。

23 = ( a b \-- f ) a=b → 1。

24 \> ( a b \-- f ) a\>b → 1。

25 +! ( n a \-- ) a のセルに加算。

26 \' ( \-- a ) 次語のアドレス（辞書）を取得。

27 for ( n \-- ) FOR ループ開始。

28 next ( \-- ) FOR ループ終端。

29 and ( a b \-- c ) AND。

30 or ( a b \-- c ) OR。

31 xor ( a b \-- c ) XOR。

**5.2 システムプリミティブ（32--44）**

32 key ( \-- n ) 次のキー入力（ブロック）。

33 ?key ( \-- n ) キー有無（1/0）。

34 emit ( n \-- ) 文字出力。

35 ztype ( a \-- ) NUL 終端文字列出力。

36 fopen ( nm md \-- h ) ファイルをモード md で開く（失敗時 h=0）。

37 fclose ( h \-- ) ファイルクローズ。

38 fread ( a sz h \-- n ) 読み込み。

39 fwrite ( a sz h \-- n ) 書き込み。

40 ms ( n \-- ) ミリ秒スリープ。

41 timer ( \-- n ) 現在時刻（実装依存）。

42 add-word ( \-- ) 次語を辞書へ追加。

43 outer ( a \-- ) アウターインタプリタを a 上で実行。

44 system ( a \-- ) \`system(a)\` を実行。

------------------------------------------------------------------------

**6. 辞書と言語機能**

**6.1 INLINE**

- 語を **INLINE 指定**すると、呼び出しではなく**定義をコピー**して展開。

- パフォーマンス/サイズのトレードオフを制御。

**6.2 Transient 語**

- t0--t9 は**一時語**で辞書に登録しない。小分けの因数分解に使う。

- 大文字の T0 などは通常語（辞書登録）となる。

------------------------------------------------------------------------

**7. 代表的な上位語（例）**

具体的な上位語は boot.fth / editor.fth
に定義があります。代表例（概念的）：

- 基本 I/O: . CR SPACE TYPE など

- 制御構文: IF \... THEN BEGIN \... UNTIL FOR \... NEXT

- 文字列/バッファ操作: HERE ALLOT , C, 等

※ 実装と一致する正確な一覧は、実際の .fth を参照してください。

------------------------------------------------------------------------

**8. 組み込み（Embedding）**

- system.c に**埋め込みサンプル**あり。

- C/C++ アプリ内から VM を初期化し、outer を回し、必要に応じて system
  フックで OS 連携。

------------------------------------------------------------------------

**9. サンプルセッション**

: SQUARE ( n \-- n ) DUP \* ;

5 SQUARE . \\ → 25 出力

\\ コメント

\[ 1 2 + \] . \\ 即時解釈で 3 出力

------------------------------------------------------------------------

**10. 開発メモ**

- boot.fth を自動ロードする設計が一般的。

- editor.fth は簡易エディタ実装（キー入力プリミティブを使用）。

- 最小コアなので、**ファイル操作/デバイス依存の語は必要に応じて拡張**。

------------------------------------------------------------------------

**付録 A: 用語**

- **XT**: eXecution Token（実行アドレス）

- **TOS/NOS**: Top/Next Of Stack

- **RTOS**: Return-Stack の TOS

- **CELL/BYTE**: 実装依存サイズ（DWC のセルは 32bit/64bit 環境に追従）

------------------------------------------------------------------------

**付録 B: 参考実装ファイル**

- dwc-vm.c / dwc-vm.h / system.c

- boot.fth / editor.fth

- dwc.sln / dwc.vcxproj / makefile

------------------------------------------------------------------------

**更新履歴**

- 2025-08-11 初版（ドラフト）


